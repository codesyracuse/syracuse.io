---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { getMostRecentEventDate } from "../lib/meetup";

const allGroups = await getCollection("groups");
const images = import.meta.glob("/src/assets/groups/*");

// Sort groups by most recent event (newest first), groups with no events last
const groups = allGroups.sort((a, b) => {
  const dateA = getMostRecentEventDate(a.data.groupId);
  const dateB = getMostRecentEventDate(b.data.groupId);
  if (!dateA && !dateB) return 0;
  if (!dateA) return 1;
  if (!dateB) return -1;
  return dateB.getTime() - dateA.getTime();
});
---

<div
  class="mx-auto mt-16 grid max-w-3xl auto-rows-fr grid-cols-1 gap-8 sm:mt-20 sm:grid-cols-2 lg:mx-0 lg:max-w-none"
>
  {
    groups.map((group) => (
      <article class="relative isolate flex flex-col justify-stretch overflow-hidden rounded-2xl border border-neutral-200 bg-white dark:border-neutral-700 dark:bg-neutral-800">
        <div class="relative w-full">
          <div class="relative isolate flex flex-col justify-start overflow-hidden bg-neutral-900">
            <Image
              src={images[group.data.imagePath]()}
              alt={group.data.imgAlt}
              class="absolute inset-0 -z-10 aspect-video size-full bg-neutral-100 object-cover"
            />
            <div class="absolute inset-0 -z-10 bg-gradient-to-t from-neutral-700 via-neutral-700/40 dark:from-neutral-900 dark:via-neutral-900/40" />
            <div class="absolute inset-0 -z-10 ring-1 ring-inset ring-neutral-900/10" />
            <h3 class="mt-3 px-8 pb-4 pt-48 text-3xl font-semibold text-white">
              <a href={`/groups/${group.data.groupId}`} class="no-underline">
                <span class="absolute inset-0 font-mono" />
                {group.data.title}
              </a>
            </h3>
          </div>
        </div>
        <div class="flex flex-grow flex-col p-8">
          <div class="group relative">
            <p class="text-md/6 line-clamp-3 text-gray-600 dark:text-gray-300">
              {group.data.summary}
            </p>
          </div>
          <div class="relative mt-auto flex items-center justify-between gap-x-4 pt-8">
            <div class="text-sm/6">
              {group.data.organizers?.length > 0 && (
                <div>
                  Organizers:
                  <ul>
                    {group.data.organizers?.map((organizer) => (
                      <li class="font-semibold text-gray-900 dark:text-gray-100">
                        {organizer}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
            {getMostRecentEventDate(group.data.groupId) && (
              <p class="text-sm text-gray-500 dark:text-gray-400">
                Last event:{" "}
                {getMostRecentEventDate(group.data.groupId)!.toLocaleDateString(
                  "en-US",
                  { month: "short", day: "numeric", year: "numeric" }
                )}
              </p>
            )}
          </div>
        </div>
      </article>
    ))
  }
</div>
