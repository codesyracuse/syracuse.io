---
import { marked } from "marked";
import BaseLayout from "../../layouts/BaseLayout.astro";
import JobBadge from "../../components/jobs/JobBadge.astro";
import JobSchema from "../../components/jobs/JobSchema.astro";
import {
  fetchJobById,
  parseIdFromSlug,
  formatSalary,
  formatRelativeDate,
} from "../../lib/jobkit";

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect("/jobs");
}

const jobId = parseIdFromSlug(slug);

if (!jobId) {
  return Astro.redirect("/jobs");
}

const job = await fetchJobById(jobId);

if (!job) {
  return new Response(null, {
    status: 404,
    statusText: "Job not found",
  });
}

const salary = formatSalary(job);
const relativeDate = formatRelativeDate(job.created_at);
const descriptionHtml = marked(job.description);

const pageTitle = `${job.title} at ${job.company} - Syracuse, NY | syracuse.io`;
const pageDescription =
  job.description
    .replace(/[#*[\]]/g, "")
    .slice(0, 160)
    .trim() + "...";
---

<BaseLayout
  content={{
    title: pageTitle,
  }}
>
  <Fragment slot="head">
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="canonical" href={`https://syracuse.io/jobs/${slug}`} />
    <JobSchema job={job} />
  </Fragment>

  <div class="mx-auto max-w-4xl px-4 py-12">
    <div class="mb-6">
      <a
        href="/jobs"
        class="inline-flex items-center text-sm font-medium text-orange-600 hover:text-orange-700 dark:text-orange-400 dark:hover:text-orange-300"
      >
        <svg
          class="mr-2 h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to all jobs
      </a>
    </div>

    <article
      class="overflow-hidden rounded-lg border-2 border-neutral-200 bg-white dark:border-neutral-800 dark:bg-neutral-900"
    >
      <div
        class="border-b-2 border-neutral-200 bg-neutral-50 p-8 dark:border-neutral-800 dark:bg-neutral-950"
      >
        <div class="flex items-start gap-6">
          {
            job.logo && (
              <div class="flex-shrink-0">
                <img
                  src={job.logo}
                  alt={`${job.company} logo`}
                  class="h-20 w-20 rounded-lg object-contain"
                />
              </div>
            )
          }

          <div class="flex-1">
            <h1
              class="mb-3 text-3xl font-bold text-neutral-900 md:text-4xl dark:text-white"
            >
              {job.title}
            </h1>

            <div
              class="mb-4 flex flex-wrap items-center gap-2 text-lg text-neutral-700 dark:text-neutral-300"
            >
              <span class="font-semibold">{job.company}</span>
              {
                job.company_website && (
                  <>
                    <span>â€¢</span>
                    <a
                      href={job.company_website}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-orange-600 hover:underline dark:text-orange-400"
                    >
                      Website
                    </a>
                  </>
                )
              }
            </div>

            <div class="flex flex-wrap gap-2">
              <JobBadge text={job.term.name} variant="primary" />
              <JobBadge text={job.category.name} variant="secondary" />
              {
                job.arrangement && (
                  <JobBadge
                    text={
                      job.arrangement.charAt(0).toUpperCase() +
                      job.arrangement.slice(1)
                    }
                    variant="accent"
                  />
                )
              }
            </div>
          </div>
        </div>
      </div>

      <div class="p-8">
        <div
          class="mb-6 grid gap-4 border-b-2 border-neutral-200 pb-6 md:grid-cols-3 dark:border-neutral-800"
        >
          <div>
            <h3
              class="mb-1 text-sm font-medium text-neutral-500 dark:text-neutral-400"
            >
              Location
            </h3>
            <p class="text-lg font-semibold text-neutral-900 dark:text-white">
              {job.location}
            </p>
          </div>

          {
            salary && (
              <div>
                <h3 class="mb-1 text-sm font-medium text-neutral-500 dark:text-neutral-400">
                  Salary
                </h3>
                <p class="text-lg font-semibold text-neutral-900 dark:text-white">
                  {salary}
                </p>
              </div>
            )
          }

          <div>
            <h3
              class="mb-1 text-sm font-medium text-neutral-500 dark:text-neutral-400"
            >
              Posted
            </h3>
            <p class="text-lg font-semibold text-neutral-900 dark:text-white">
              {relativeDate}
            </p>
          </div>
        </div>

        <div
          class="prose prose-lg max-w-none dark:prose-invert prose-headings:text-neutral-900 prose-a:text-orange-600 dark:prose-headings:text-white dark:prose-a:text-orange-400"
        >
          <Fragment set:html={descriptionHtml} />
        </div>

        <div
          class="mt-8 flex flex-col gap-4 border-t-2 border-neutral-200 pt-8 sm:flex-row dark:border-neutral-800"
        >
          <a
            href={`https://jobs.syracuse.io/jobs/${job.id}`}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block rounded-lg bg-orange-600 px-8 py-4 text-center text-lg font-semibold text-white transition-colors hover:bg-orange-700"
          >
            Apply for this Job
          </a>

          <a
            href="/jobs"
            class="inline-block rounded-lg border-2 border-neutral-300 bg-white px-8 py-4 text-center text-lg font-semibold text-neutral-700 transition-colors hover:bg-neutral-50 dark:border-neutral-700 dark:bg-neutral-800 dark:text-neutral-300 dark:hover:bg-neutral-700"
          >
            View All Jobs
          </a>
        </div>
      </div>
    </article>
  </div>
</BaseLayout>
